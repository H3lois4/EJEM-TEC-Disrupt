{% extends "base.html" %}
{% load static %}
{# REMOVIDO: {% load custom_filters %} - Não precisa mais de NENHUM filtro customizado #}

{% block title %}Parametrização - {{ projeto.nome }}{% endblock %}

{% block titulo_pagina %}
    <span>PARAMETRIZAÇÃO</span> {# Título da página no header superior #}
{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/tabelas.css' %}">
{% endblock %}

{% block content %}
<div class="parametrizacao-page-container">
    <header class="header-interno">
        <h1>Parametrização BIA para o Projeto: {{ projeto.nome }}</h1>
    </header>

    {% if parametrizacoes_com_operacoes %}
        {% for item in parametrizacoes_com_operacoes %}
            {# Usando 'with' para simplificar o acesso aos dados pré-processados da view #}
            {% with entrada=item.parametrizacao nomes_operacoes_colunas=item.nomes_operacoes_colunas dados_tabela_por_nivel=item.dados_tabela_por_nivel %}
            <div class="parametrizacao-table-section">
                <div class="parametrizacao-table-header">
                    <h2>Parametrização #{{ entrada.id }}</h2>
                    <div class="parametrizacao-actions">
                        <a href="{% url 'projetos:editar_parametrizacao_bia' projeto.id entrada.id %}" class="btn-editar-tabela">Editar</a>
                        <form method="post" action="{% url 'projetos:deletar_parametrizacao_bia' projeto.id entrada.id %}" style="display:inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn-deletar-tabela" onclick="return confirm('Tem certeza que deseja excluir esta parametrização?');">Excluir</button>
                        </form>
                    </div>
                </div>

                <div class="table-responsive-custom"> 
                    <table class="parametrizacao-grid-table"> 
                        <thead>
                            <tr>
                                <th rowspan="2">NÍVEL DO IMPACTO</th>
                                <th rowspan="2">CLASSIFICAÇÃO DO IMPACTO</th>
                                <th colspan="1">FINANCEIRO</th>
                                <th colspan="2">IMAGEM E REPUTAÇÃO</th>
                                
                                {# COLUNA OPERACIONAL DINÂMICA: colspan baseado no número de nomes de operações #}
                                <th colspan="{{ nomes_operacoes_colunas|length|default:1 }}">OPERACIONAL</th> 
                                
                                <th colspan="2">LEGAL E COMPLIANCE</th>
                                <th colspan="3">ESG</th> 
                            </tr>
                            <tr>
                                <th>Valor de exposição</th>
                                <th>Mídias</th>
                                <th>Stakeholders</th>
                                
                                {# SUBTÍTULOS OPERACIONAIS DINÂMICOS: Nomes das operações #}
                                {% for nome_op in nomes_operacoes_colunas %}
                                    <th>{{ nome_op }}</th>
                                {% empty %}
                                    {# Caso não haja operações associadas a essa parametrização #}
                                    <th class="text-muted">N/A</th> 
                                {% endfor %}
                                
                                <th>Penalidade</th>
                                <th>Contrato</th>
                                <th>Impacto ao Meio Ambiente</th>
                                <th>Impacto Social</th>
                                <th>Impacto na Estratégia e Governança</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Loop para cada linha de dados de nível #}
                            {% for row in dados_tabela_por_nivel %}
                                <tr>
                                    <td>{{ row.nivel }}</td>
                                    <td>{{ row.classificacao }}</td>
                                    <td>{{ row.valor_exposicao|default_if_none:"-" }}</td>
                                    <td>{{ row.img_rep_midias|default_if_none:"-" }}</td>
                                    <td>{{ row.img_rep_stakeholders|default_if_none:"-" }}</td>
                                    
                                    {# CÉLULAS OPERACIONAIS DINÂMICAS #}
                                    {% if row.operacionais %}
                                        {% for valor_op_nivel in row.operacionais %}
                                            <td>{{ valor_op_nivel|default_if_none:"-" }}</td>
                                        {% endfor %}
                                    {% else %}
                                        {# Se não houver dados operacionais para este nível, preenche com "-" para o número correto de colunas #}
                                        {% for _ in nomes_operacoes_colunas %}
                                            <td>-</td>
                                        {% empty %}
                                            {# Se nomes_operacoes_colunas também está vazia, apenas um '-' para a célula única #}
                                            <td>-</td>
                                        {% endfor %}
                                    {% endif %}
                                    
                                    <td>{{ row.legal_penalidade|default_if_none:"-" }}</td>
                                    <td>{{ row.legal_contrato|default_if_none:"-" }}</td>
                                    <td>{{ row.amb|default_if_none:"-" }}</td>
                                    <td>{{ row.social|default_if_none:"-" }}</td>
                                    <td>{{ row.estrategia|default_if_none:"-" }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endwith %}
        {% endfor %}
    {% else %}
        <div class="empty-table-message">
            <p>Nenhuma parametrização BIA encontrada para este projeto ainda.</p>
        </div>
    {% endif %}

    <div style="margin-top: 25px;">
        <a href="{% url 'projetos:adicionar_parametrizacao_bia' projeto.id %}" class="btn-principal">Adicionar nova Parametrização ...</a>
        <a href="{% url 'projetos:detalhe_projeto' projeto.id %}" class="btn-secundario">Voltar para Detalhes do Projeto</a>
    </div>

</div>
{% endblock %}